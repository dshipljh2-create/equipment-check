<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>2. 순수설비50 점검 체크시트</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: "Noto Sans KR", sans-serif; margin: 20px; }
  h2 { color: #333; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f5f5f5; font-weight: bold; }
  input[type="text"] { width: 100%; padding: 4px; box-sizing: border-box; }
  label { margin-right: 10px; cursor: pointer; }
  input[type="radio"] { margin-right: 3px; cursor: pointer; }
  button { margin-top: 15px; padding: 10px 20px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer; font-size: 16px; }
  button:hover { background: #0056b3; }
  .access-denied { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; border: 2px solid #f5c6cb; }
  .access-granted { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 10px; text-align: center; }
</style>
</head>
<body>

<h2>2. 순수설비50 점검 체크시트</h2>

<div id="accessStatus"></div>

<div id="contentArea" style="display: none;">
  <table>
    <tr><th>코드</th><th>부위</th><th>점검항목</th><th>기준</th><th>빈도</th><th>결과입력</th></tr>
    <tr><td>check2-1</td><td>전도도</td><td>판넬확인</td><td>1㏁ 이상</td><td>1회/일</td><td><input type="text" id="check2-1"></td></tr>
    <tr><td>check2-2</td><td>펌프</td><td>소음 확인</td><td>이상 없을것</td><td>1회/일</td>
      <td><label><input type="radio" name="check2-2" value="정상" checked>정상</label>
          <label><input type="radio" name="check2-2" value="비정상">비정상</label></td></tr>
    <tr><td>check2-3</td><td>펌프</td><td>누수 확인</td><td>없을것</td><td>1회/일</td>
      <td><label><input type="radio" name="check2-3" value="정상" checked>정상</label>
          <label><input type="radio" name="check2-3" value="비정상">비정상</label></td></tr>
    <tr><td>check2-4</td><td>배관</td><td>누수 확인</td><td>없을것</td><td>1회/일</td>
      <td><label><input type="radio" name="check2-4" value="정상" checked>정상</label>
          <label><input type="radio" name="check2-4" value="비정상">비정상</label></td></tr>
    <tr><td>check2-5</td><td>필터</td><td>입출구 압력 편차</td><td>2k 이하</td><td>1회/주</td><td><input type="text" id="check2-5"></td></tr>
    <tr><td>check2-6</td><td>멤브레인</td><td>생산 유량</td><td>35L/min 이상</td><td>1회/주</td><td><input type="text" id="check2-6"></td></tr>
    <tr><td>check2-7</td><td>제어반</td><td>전기배선</td><td>피복 벗겨짐 없을것</td><td>1회/월</td>
      <td><label><input type="radio" name="check2-7" value="정상" checked>정상</label>
          <label><input type="radio" name="check2-7" value="비정상">비정상</label></td></tr>
    <tr><td>check2-8</td><td>종합</td><td>특이사항</td><td></td><td></td><td><input type="text" id="check2-8"></td></tr>
  </table>

  <button id="saveBtn">작성 완료</button>
</div>

<script>
const SUPABASE_URL = 'https://vqimgnjodisawujcwfuv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxaW1nbmpvZGlzYXd1amN3ZnV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjkzOTYsImV4cCI6MjA3ODYwNTM5Nn0.j31IoziLjkiQ0r7il8PUOEv9ylGm6ZTIVGSVDVgS5F0';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const VALID_TOKEN = 'EQUIP_CHECK_2024_SECURE';

function verifyAccess() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const saved = sessionStorage.getItem('access_token');
  if (token === VALID_TOKEN) { sessionStorage.setItem('access_token', token); return true; }
  if (saved === VALID_TOKEN) return true;
  return false;
}

window.addEventListener('DOMContentLoaded', () => {
  const status = document.getElementById('accessStatus');
  const area = document.getElementById('contentArea');

  if (verifyAccess()) {
    status.innerHTML = `<div class="access-granted">✅ QR코드를 통한 정상 접근이 확인되었습니다.</div>`;
    area.style.display = 'block';
  } else {
    status.innerHTML = `
      <div class="access-denied">
        <h3>⚠️ 접근 권한이 없습니다</h3>
        <p>이 페이지는 QR코드를 통해서만 접근할 수 있습니다.</p>
        <p>올바른 QR코드를 스캔해주세요.</p>
      </div>`;
    area.style.display = 'none';
  }
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!verifyAccess()) { alert('⚠️ 접근 권한이 없습니다. QR코드를 통해 접속해주세요.'); return; }

  const now = new Date().toISOString();
  const items = ["check2-1","check2-2","check2-3","check2-4","check2-5","check2-6","check2-7","check2-8"];
  const textCodes = ["check2-1","check2-5","check2-6","check2-8"];
  const records = [];

  items.forEach(code => {
    let val = "";
    if (textCodes.includes(code)) {
      val = document.getElementById(code).value;
    } else {
      const r = document.querySelector(`input[name="${code}"]:checked`);
      val = r ? r.value : "정상";
    }
    if (val.trim() !== "") {
      records.push({ check_code: code, equipment: "2. 순수설비50", check_result: val, check_time: now });
    }
  });

  if (records.length === 0) { alert("입력값이 없습니다."); return; }

  const { error } = await supabase.from('check_logs').insert(records);
  if (error) alert("저장 실패: " + error.message);
  else alert("저장 완료!");
});
</script>

</body>
</html>
